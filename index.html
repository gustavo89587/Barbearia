<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barbearia Milenitos — Agendamento</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ========== PALETA POR TEMA (LIGHT DEFAULT) ========== */
    :root[data-theme="light"]{
      --bg:#f7f7f9;
      --card:#ffffff;
      --card-2:#fafafb;
      --muted:#6b7280;
      --text:#0f1115;
      --red:#ef4444;
      --red-600:#dc2626;
      --red-700:#b91c1c;
      --ring: 0 0 0 .2rem rgba(239,68,68,.22);
      --shadow: 0 8px 28px rgba(0,0,0,.08);
      --glass: rgba(255,255,255,.7);
      --bd: rgba(17,24,39,.08);
      --success:#16a34a;
      --warning:#f59e0b;
    }
    :root[data-theme="dark"]{
      --bg:#0b0b0c;
      --card:#141417;
      --card-2:#16181b;
      --muted:#a7a7ad;
      --text:#f2f2f5;
      --red:#ef4444;
      --red-600:#dc2626;
      --red-700:#b91c1c;
      --ring: 0 0 0 .2rem rgba(239,68,68,.35);
      --shadow: 0 20px 60px rgba(0,0,0,.5);
      --glass: rgba(20,20,23,.72);
      --bd: rgba(255,255,255,.08);
      --success:#16a34a;
      --warning:#f59e0b;
      

    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg);
      color:var(--text);
    }
    .container-app{max-width:1100px}

    /* ================== GLASS / CARDS ================== */
    .glass{
      background:var(--glass);
      backdrop-filter:saturate(140%) blur(10px);
      -webkit-backdrop-filter:saturate(140%) blur(10px);
      border:1px solid var(--bd);
      border-radius:18px;
      box-shadow:var(--shadow);
    }
    .card{
      background:linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
      border:1px solid var(--bd);
      border-radius:16px!important;
      box-shadow:0 8px 30px rgba(0,0,0,.08);
    }
    [data-theme="dark"] .card{ box-shadow:0 8px 30px rgba(0,0,0,.35); }
    .card.hoverable{transition:transform .25s, box-shadow .25s, border-color .25s}
    .card.hoverable:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 50px rgba(0,0,0,.12);
      border-color:rgba(239,68,68,.22);
    }

    /* ================== HEADER ================== */
    .app-header{
      position:sticky;top:0;z-index:30;
      padding:14px 18px;
      background:linear-gradient(180deg, rgba(255,255,255,.85) 0%, rgba(255,255,255,.6) 100%);
      backdrop-filter: blur(8px);
      border:1px solid var(--bd);
      border-radius:18px;
      margin-bottom:18px;
    }
    [data-theme="dark"] .app-header{
      background:linear-gradient(180deg, rgba(20,20,23,.92) 0%, rgba(20,20,23,.66) 100%);
    }
    .brand-badge{
      width:64px;height:64px;border-radius:14px;overflow:hidden;
      border:2px solid rgba(239,68,68,.5);
      display:grid;place-items:center;background:#f3f4f6;
    }
    [data-theme="dark"] .brand-badge{ background:#151518; }
    .brand-badge img{width:46px;height:46px;object-fit:contain;filter:drop-shadow(0 4px 14px rgba(239,68,68,.35))}
    .title-grad{
      font-weight:800;letter-spacing:.2px;
      color:var(--text);
    }

    /* ================== TYPO ================== */
    .muted{color:var(--muted)!important}
    .headline{color:var(--red);font-weight:800}
    .subhead{
      font-weight:700;color:var(--red);border-bottom:2px solid rgba(239,68,68,.25);
      padding-bottom:.35rem;margin-bottom:1rem
    }
    .badge-soft{
      border:1px solid rgba(239,68,68,.28);
      background:linear-gradient(180deg, rgba(239,68,68,.12), rgba(239,68,68,.06));
      color:inherit; font-weight:700
    }

    /* ================== BUTTONS ================== */
    .btn-primary{
      background:linear-gradient(180deg,var(--red) 0%, var(--red-600) 100%)!important;
      border-color:var(--red-700)!important;
      color:#fff!important;
      font-weight:700; letter-spacing:.2px;
      box-shadow:0 6px 14px rgba(239,68,68,.18);
      transition:transform .18s, box-shadow .18s;
    }
    .btn-primary:hover{transform:translateY(-1px); box-shadow:0 10px 24px rgba(239,68,68,.25)}
    .btn-dark{
      background:#e9e9ee!important; border-color:#d1d5db!important; color:#111827!important
    }
    [data-theme="dark"] .btn-dark{
      background:#1b1c20!important; border-color:#2a2c31!important; color:#e9e9ee!important
    }
    .btn-outline-light{
      color:var(--red)!important;border-color:rgba(239,68,68,.35)!important
    }
    .btn-outline-light:hover{background:var(--red-600)!important;color:white!important}

    .clickable{
      cursor:pointer;border:1px solid transparent;border-radius:14px;
      background:#ffffff; transition:all .2s
    }
    [data-theme="dark"] .clickable{ background:#16171b; }
    .clickable:hover{border-color:rgba(239,68,68,.28); box-shadow:0 6px 18px rgba(239,68,68,.10)}
    .clickable.selected{
      border-color:var(--red-600); box-shadow:0 10px 26px rgba(239,68,68,.18); background:#fff7f7
    }
    [data-theme="dark"] .clickable.selected{ background:#1b1c21 }

    /* ================== FORMS ================== */
    .form-control, .form-select{
      background:#ffffff!important;border:1px solid #d1d5db!important;color:var(--text)!important;
      border-radius:12px!important;
    }
    [data-theme="dark"] .form-control, [data-theme="dark"] .form-select{
      background:#141519!important;border:1px solid #2a2c31!important;color:#f2f2f5!important;
    }
    .form-control:focus, .form-select:focus{
      border-color:var(--red-600)!important; box-shadow:var(--ring)!important;
    }
    input[type="date"]{color-scheme:light}
    [data-theme="dark"] input[type="date"]{color-scheme:dark}

    /* ================== SLOTS GRID ================== */
    .slot{min-width:92px}
    .slot .btn{width:100%}

    /* ================== CTA STICKY ================== */
    .cta-sticky{
      position:sticky; bottom:16px; z-index:40;
      background:linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.85) 30%, rgba(255,255,255,.95) 100%);
      padding-top:10px; border-radius:16px;
    }
    [data-theme="dark"] .cta-sticky{
      background:linear-gradient(180deg, rgba(11,11,12,0) 0%, rgba(11,11,12,.85) 30%, rgba(11,11,12,.95) 100%);
    }

    /* Skeletons */
    .skeleton{position:relative;overflow:hidden;background:#e5e7eb;border-radius:12px}
    [data-theme="dark"] .skeleton{background:#1b1c20}
    .skeleton::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(100deg, transparent 30%, rgba(255,255,255,.35) 50%, transparent 70%);
      animation:shimmer 1.4s infinite
    }
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    /* Reduced Motion */
    @media (prefers-reduced-motion:reduce){
      .card.hoverable,.btn-primary,.clickable{transition:none}
    }
  </style>
</head>
<body>
  <div class="container container-app py-3">

    <!-- Header -->
    <header class="app-header glass">
      <div class="d-flex align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          <span class="brand-badge">
            <img id="barbershop-logo-img" src="https://placehold.co/56x56/ef4444/ffffff?text=M" alt="Logo Barbearia Milenitos" />
          </span>
          <div>
            <h1 class="h3 m-0 title-grad">Barbearia Milenitos</h1>
            <small class="muted">Agendamento rápido • Atendimento premium</small>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <!-- TOGGLE DE TEMA -->
          <button id="theme-toggle" class="btn btn-outline-light btn-sm me-1" aria-label="Alternar tema (claro/escuro)" title="Tema">
            <i id="theme-toggle-icon" data-lucide="sun" class="w-4 h-4"></i>
          </button>
          <span id="user-display" class="muted small">Conectando…</span>
          <button class="btn btn-outline-light btn-sm" id="logout-btn" aria-label="Sair">
            <i data-lucide="log-out" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Info -->
    <section class="card p-4 mb-3 hoverable">
      <h2 class="subhead h5">Informações da Barbearia</h2>
      <div class="row g-4">
        <div class="col-md-6">
          <p class="fw-semibold text-uppercase small mb-1"><i data-lucide="map-pin" class="me-2"></i>Endereço</p>
          <p id="barbershop-address" class="mb-0">—</p>
        </div>
        <div class="col-md-6">
          <p class="fw-semibold text-uppercase small mb-1"><i data-lucide="wallet" class="me-2"></i>Pagamentos</p>
          <ul id="payment-methods-list" class="mb-0 ps-3 small"></ul>
        </div>
      </div>
    </section>

    <!-- Assinaturas -->
    <section class="card p-4 mb-3 hoverable">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="subhead h5 m-0">Gerenciamento de Assinaturas</h2>
        <span id="sub-badge" class="badge badge-soft rounded-pill px-3 py-2">Status</span>
      </div>

      <div id="sub-status-display" class="p-3 glass">
        <p class="fw-bold mb-1"><i data-lucide="award" class="me-2"></i>Status da Assinatura</p>
        <p id="sub-details" class="mb-0">Carregando…</p>
      </div>

      <h3 class="h6 text-uppercase mt-4 mb-3">Planos Disponíveis</h3>
      <div id="subscription-plans-list" class="row g-3">
        <!-- Inject -->
      </div>
    </section>

    <!-- Passo 1 -->
    <section class="card p-4 mb-3 hoverable">
      <h2 class="subhead h5">1. Escolha o Serviço</h2>
      <div id="services-list" class="row g-3">
        <!-- Inject -->
      </div>
      <div id="selected-service-display" class="mt-3 glass d-none">
        <p class="mb-0" id="selected-service-details"></p>
      </div>
    </section>

    <!-- Passo 2 -->
    <section id="barber-selection-section" class="card p-4 mb-3 hoverable opacity-50 pointer-events-none">
      <h2 class="subhead h5">2. Escolha o Barbeiro</h2>
      <div id="barbers-list" class="row g-3">
        <!-- Inject -->
      </div>
      <div id="selected-barber-display" class="mt-3 glass d-none">
        <p class="mb-0" id="selected-barber-details"></p>
      </div>
    </section>

    <!-- Passo 3 -->
    <section id="datetime-selection-section" class="card p-4 mb-3 hoverable opacity-50 pointer-events-none">
      <h2 class="subhead h5">3. Data e Hora</h2>
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="appointment-date" class="form-label muted">Data</label>
          <input type="date" id="appointment-date" class="form-control" aria-describedby="date-help" />
          <div id="date-help" class="form-text text-secondary">Escolha um dia disponível</div>
        </div>
        <div class="col-md-8">
          <label class="form-label muted">Horários</label>
          <div id="time-slots-container" class="row g-2">
            <div class="col-12">
              <div class="skeleton" style="height:48px;"></div>
            </div>
          </div>
          <p id="time-slots-message" class="muted small mt-2">Selecione uma data para ver horários.</p>
        </div>
      </div>

      <div class="cta-sticky mt-3">
        <button id="book-button" class="btn btn-primary btn-lg w-100" disabled>Selecione serviço, barbeiro, data e hora</button>
      </div>
    </section>

    <!-- Seus agendamentos -->
    <section class="card p-4 mb-4 hoverable">
      <h2 class="subhead h5">Seus Agendamentos Futuros</h2>
      <div id="user-appointments-list" class="d-grid gap-3">
        <p id="no-appointments-message" class="text-center muted m-0">Nenhum agendamento encontrado.</p>
      </div>
    </section>

    <!-- Toasts -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1090">
      <div id="toast" class="toast text-bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
        <div class="toast-body" id="toast-body">Pronto.</div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card">
          <div class="modal-header border-0">
            <h5 class="modal-title headline" id="modalTitle">Status</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <p id="modal-message" class="mb-0"></p>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- APP JS + Firebase -->
  <script type="module">
    /* ================== THEME TOGGLE ================== */
    function applyTheme(theme){
      const root = document.documentElement;
      root.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const icon = document.getElementById('theme-toggle-icon');
      if(icon){
        icon.setAttribute('data-lucide', theme === 'dark' ? 'moon' : 'sun');
        if(window.lucide) window.lucide.createIcons();
      }
      const btn = document.getElementById('theme-toggle');
      if(btn) btn.setAttribute('aria-label', \`Alternar tema (atual: \${theme})\`);
    }
    // inicia com salvo (ou claro por padrão)
    (() => {
      const saved = localStorage.getItem('theme');
      applyTheme(saved || 'light');
    })();
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('theme-toggle')?.addEventListener('click', ()=>{
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        applyTheme(current === 'light' ? 'dark' : 'light');
      });
      // respeita troca do SO se usuário não escolheu manualmente
      try{
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        mq.addEventListener?.('change', (e)=>{
          if(!localStorage.getItem('theme')){
            applyTheme(e.matches ? 'dark' : 'light');
          }
        });
      }catch(_){}
    });

    /* ================== FIREBASE ================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ================== CONFIG/GLOBALS ================== */
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth, userId = null, isAuthReady = false;
    let statusModalInstance, toastInstance;

    const selected = { service:null, barber:null, date:null, time:null, timeStr:null };
    let existingAppointments = [];
    let userSubscription = null;

    // Data estática
    const services = [
      { id:'corte', name:'Corte de Cabelo Clássico', price:60.00, duration:60, icon:'scissors' },
      { id:'barba', name:'Design de Barba',           price:40.00, duration:30, icon:'sparkles' }, /* 'beard' não existe no Lucide */
      { id:'completo', name:'Combo (Corte + Barba)',  price:90.00, duration:90, icon:'wand-2' },
      { id:'pigmentacao', name:'Pigmentação',         price:50.00, duration:45, icon:'palette' }
    ];

    const barbers = [
      { id:'joao',  name:'João “O Mestre”',  specialty:'Clássico e Taper Fade',     image:'https://placehold.co/100x100/1f2430/c6cad3?text=JO' },
      { id:'maria', name:'Maria “A Navalha”',specialty:'Barba Terapia e Design',    image:'https://placehold.co/100x100/1f2430/c6cad3?text=MA' },
      { id:'pedro', name:'Pedro “O Artista”',specialty:'Freestyle e Colorimetria',  image:'https://placehold.co/100x100/1f2430/c6cad3?text=PE' }
    ];

    const barbershopInfo = {
      name:"Barbearia Milenitos",
      address:"Rua da Tecnologia, 123 — Centro, São Paulo/SP",
      payments:["Cartão (Visa/Master)","Pix (Chave: 1234567890)","Dinheiro"],
      logoUrl:"https://placehold.co/56x56/ef4444/ffffff?text=M"
    };

    const subscriptionPlans = [
      { id:'trimestral', name:'Plano Trimestral', cuts:4, price:200.00, description:'4 cortes em 90 dias' },
      { id:'mensal',     name:'Plano Mensal',     cuts:2, price:100.00, description:'2 cortes em 30 dias' }
    ];

    /* ================== HELPERS ================== */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    function toast(msg){
      $('#toast-body').textContent = msg;
      toastInstance?.show();
    }
    function showModal(title, message){
      $('#modalTitle').textContent = title;
      $('#modal-message').innerHTML = message;
      statusModalInstance?.show();
    }
    function setMinToday(input){
      const t = new Date();
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth()+1).padStart(2,'0');
      const dd = String(t.getDate()).padStart(2,'0');
      input.min = `${yyyy}-${mm}-${dd}`;
    }
    function timeToDate(dateStr, timeStr){
      if(!dateStr || !timeStr) return null;
      const [y,m,d] = dateStr.split('-').map(Number);
      const [H,M]  = timeStr.split(':').map(Number);
      return new Date(y, m-1, d, H, M);
    }

    function getAppointmentsCollectionPath(){ return `artifacts/${appId}/public/data/barbershop_appointments`; }
    function getSubscriptionCollectionPath(docId='current'){ return `artifacts/${appId}/users/${userId}/subscriptions/${docId}`; }

    /* ================== RENDER: STATIC ================== */
    function renderBarbershopInfo(){
      const logo = $('#barbershop-logo-img');
      if(logo && barbershopInfo.logoUrl) logo.src = barbershopInfo.logoUrl;
      $('#barbershop-address').textContent = barbershopInfo.address;
      $('#payment-methods-list').innerHTML = barbershopInfo.payments.map(p=>`<li>${p}</li>`).join('');
      lucide.createIcons();
    }

    function renderServices(){
      const list = $('#services-list'); if(!list) return;
      list.innerHTML = services.map(s=>`
        <div class="col-12 col-md-6">
          <div class="clickable card p-3 d-flex align-items-center gap-3" role="button" tabindex="0" data-service-id="${s.id}">
            <i data-lucide="${s.icon}"></i>
            <div class="flex-grow-1">
              <div class="fw-bold">${s.name}</div>
              <small class="muted">R$ ${s.price.toFixed(2)} • ${s.duration} min</small>
            </div>
          </div>
        </div>
      `).join('');
      lucide.createIcons();
      $$('#services-list [data-service-id]').forEach(el=>{
        el.addEventListener('click', ()=> selectService(el.dataset.serviceId));
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); selectService(el.dataset.serviceId);} });
      });
      updateSelectedServiceUI();
    }

    function renderBarbers(){
      const list = $('#barbers-list'); if(!list) return;
      list.innerHTML = barbers.map(b=>`
        <div class="col-6 col-md-4">
          <div class="clickable card p-3 text-center" role="button" tabindex="0" data-barber-id="${b.id}">
            <img src="${b.image}" alt="Foto de ${b.name}" class="rounded-circle mb-2" style="width:76px;height:76px;object-fit:cover;border:1px solid rgba(239,68,68,.28)">
            <div class="fw-bold">${b.name}</div>
            <small class="muted">${b.specialty}</small>
          </div>
        </div>
      `).join('');
      $$('#barbers-list [data-barber-id]').forEach(el=>{
        el.addEventListener('click', ()=> selectBarber(el.dataset.barberId));
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); selectBarber(el.dataset.barberId);} });
      });
      updateSelectedBarberUI();
    }

    /* ================== RENDER: STATEFUL ================== */
    function updateSelectedServiceUI(){
      $$('#services-list [data-service-id]').forEach(el=>{
        if(el.dataset.serviceId === selected.service?.id) el.classList.add('selected'); else el.classList.remove('selected');
      });

      const display = $('#selected-service-display');
      const barberSection = $('#barber-selection-section');
      if(selected.service){
        display.classList.remove('d-none');
        $('#selected-service-details').innerHTML = `<strong>${selected.service.name}</strong> — R$ ${selected.service.price.toFixed(2)}`;
        barberSection.classList.remove('opacity-50','pointer-events-none');
      } else{
        display.classList.add('d-none');
        barberSection.classList.add('opacity-50','pointer-events-none');
      }
      updateBookingButtonState();
    }

    function updateSelectedBarberUI(){
      $$('#barbers-list [data-barber-id]').forEach(el=>{
        if(el.dataset.barberId === selected.barber?.id) el.classList.add('selected'); else el.classList.remove('selected');
      });

      const display = $('#selected-barber-display');
      const datetimeSection = $('#datetime-selection-section');
      if(selected.barber){
        display.classList.remove('d-none');
        $('#selected-barber-details').textContent = `${selected.barber.name} (${selected.barber.specialty})`;
        datetimeSection.classList.remove('opacity-50','pointer-events-none');
      } else{
        display.classList.add('d-none');
        datetimeSection.classList.add('opacity-50','pointer-events-none');
      }
      updateBookingButtonState();
    }

    function renderTimeSlots(){
      const container = $('#time-slots-container');
      const message = $('#time-slots-message');
      if(!container || !message) return;

      container.innerHTML='';
      message.classList.add('d-none');

      if(!selected.date){
        message.textContent = 'Selecione uma data para ver os horários.';
        message.classList.remove('d-none');
        return;
      }

      const open = 8*60, close = 18*60, step = 60;
      const slots = [];
      for(let t=open; t<close; t+=step){
        const h=String(Math.floor(t/60)).padStart(2,'0');
        const m=String(t%60).padStart(2,'0');
        slots.push(`${h}:${m}`);
      }

      const bookedTimes = existingAppointments
        .filter(a=>{
          const d = new Date(a.timestamp).toISOString().split('T')[0];
          return d === selected.date && a.barberId === selected.barber?.id;
        })
        .map(a => new Date(a.timestamp).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}));

      let hasAvail = false;

      slots.forEach(timeStr=>{
        const isBooked = bookedTimes.includes(timeStr);
        const isSelected = timeStr===selected.timeStr;
        if(!isBooked) hasAvail = true;

        const cls = isSelected ? 'btn btn-primary' : (isBooked ? 'btn btn-dark disabled text-decoration-line-through' : 'btn btn-dark border-secondary');
        const col = document.createElement('div');
        col.className = 'col-4 col-sm-3 col-lg-2 slot';
        col.innerHTML = `<button class="${cls}" ${isBooked?'disabled':''} aria-pressed="${isSelected}" aria-label="Horário ${timeStr}">${timeStr}</button>`;
        col.querySelector('button')?.addEventListener('click', ()=> selectTime(timeStr));
        container.appendChild(col);
      });

      if(!hasAvail){
        message.textContent = 'Sem horários disponíveis neste dia/barbeiro.';
        message.classList.remove('d-none');
      }
      updateBookingButtonState();
    }

    function updateBookingButtonState(){
      const btn = $('#book-button'); if(!btn) return;
      let text = 'Agendar';
      if(userSubscription && userSubscription.cutsRemaining>0){
        text = `Usar 1 corte da assinatura (${userSubscription.cutsRemaining} restantes)`;
      } else{
        text = 'Agendar (pagamento na loja)';
      }

      if(selected.service && selected.barber && selected.date && selected.time){
        btn.disabled = false;
        btn.textContent = text;
      } else{
        btn.disabled = true;
        btn.textContent = 'Selecione serviço, barbeiro, data e hora';
      }
    }

    function renderUserAppointments(){
      const list = $('#user-appointments-list');
      const empty = $('#no-appointments-message');
      if(!list || !empty) return;

      list.innerHTML='';
      if(!isAuthReady || !userId){
        list.innerHTML = `<p class="text-center muted m-0">Faça login para ver seus agendamentos.</p>`;
        return;
      }

      const now = Date.now();
      const future = existingAppointments
        .filter(a=> a.userId===userId && a.timestamp>now)
        .sort((a,b)=> a.timestamp-b.timestamp);

      if(future.length===0){
        empty.classList.remove('d-none');
        return;
      }
      empty.classList.add('d-none');

      future.forEach(a=>{
        const d = new Date(a.timestamp);
        const dateStr = d.toLocaleDateString('pt-BR');
        const timeStr = d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
        const barber = barbers.find(b=>b.id===a.barberId)?.name ?? a.barberId;
        const service = services.find(s=>s.id===a.serviceName)?.name ?? a.serviceName;

        const node = document.createElement('div');
        node.className='card p-3 d-flex flex-row justify-content-between align-items-center';
        node.innerHTML = `
          <div>
            <div class="fw-bold">${service}</div>
            <small class="muted">Com ${barber}</small>
          </div>
          <div class="text-end">
            <div class="fw-semibold">${dateStr}</div>
            <small class="badge badge-soft rounded-pill px-2 py-1">${timeStr}</small>
          </div>
        `;
        list.appendChild(node);
      });

      checkForUpcomingAppointment(future);
    }

    function checkForUpcomingAppointment(apps){
      const now = Date.now(), in24h = now + 86_400_000;
      const upcoming = apps.find(a=> a.timestamp>now && a.timestamp<=in24h);
      if(upcoming){
        const d = new Date(upcoming.timestamp);
        const timeStr = d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
        const service = services.find(s=>s.id===upcoming.serviceName)?.name ?? 'Corte';
        const barber = barbers.find(b=>b.id===upcoming.barberId)?.name ?? 'Barbeiro';
        showModal('Lembrete', `Você tem **${service}** com **${barber}** hoje/amanhã às **${timeStr}**. 💈`);
      }
    }

    function renderSubscriptionManager(){
      const details = $('#sub-details'); const plans = $('#subscription-plans-list'); const badge = $('#sub-badge');
      if(!details || !plans) return;

      plans.innerHTML = subscriptionPlans.map(p=>`
        <div class="col-12 col-md-6">
          <div class="card p-4 hoverable h-100 d-flex flex-column">
            <div class="d-flex align-items-center justify-content-between">
              <div class="fw-bold">${p.name}</div>
              <span class="badge badge-soft rounded-pill">${p.cuts} cortes</span>
            </div>
            <small class="muted mt-1">${p.description}</small>
            <div class="fw-semibold mt-3 mb-2">R$ ${p.price.toFixed(2)}</div>
            <button class="btn btn-outline-light mt-auto w-100" data-plan="${p.id}">Comprar Plano</button>
          </div>
        </div>
      `).join('');
      plans.querySelectorAll('[data-plan]').forEach(b=>{
        b.addEventListener('click', ()=> purchaseSubscription(b.dataset.plan));
      });

      if(!isAuthReady){
        details.textContent = 'Faça login para gerenciar sua assinatura.';
        badge.textContent = 'Desconhecido';
        return;
      }
      if(userSubscription?.planId){
        const p = subscriptionPlans.find(x=>x.id===userSubscription.planId);
        const cuts = userSubscription.cutsRemaining ?? 0;
        const status = cuts>0 ? 'ATIVA' : 'Cortes Esgotados';
        const colorClass = cuts>0 ? 'bg-success' : 'bg-warning';
        details.innerHTML = `Plano: <strong>${p?.name ?? '—'}</strong><br>Status: <span class="${colorClass} px-2 py-1 rounded-2">${status}</span><br>Cortes restantes: <span class="fw-bold">${cuts}</span>`;
        badge.textContent = status;
      } else{
        details.textContent = 'Você não possui assinatura ativa. Escolha um plano para economizar!';
        badge.textContent = 'Sem Assinatura';
      }
    }

    /* ================== ACTIONS ================== */
    window.selectService = function(id){
      selected.service = services.find(s=>s.id===id) ?? null;
      selected.barber = selected.date = selected.time = selected.timeStr = null;
      updateSelectedServiceUI();
      updateSelectedBarberUI();
      renderTimeSlots();
    }
    window.selectBarber = function(id){
      if(!selected.service){ showModal('Atenção','Primeiro selecione um serviço.'); return; }
      selected.barber = barbers.find(b=>b.id===id) ?? null;
      selected.date = selected.time = selected.timeStr = null;
      const inp = $('#appointment-date'); if(inp) inp.value='';
      updateSelectedBarberUI(); renderTimeSlots();
    }
    window.selectTime = function(timeStr){
      if(!selected.date || !selected.barber) return;
      selected.timeStr = timeStr;
      const dt = timeToDate(selected.date, timeStr);
      selected.time = dt?.getTime() ?? null;
      renderTimeSlots();
    }

    async function handleBooking(){
      if(!selected.service || !selected.barber || !selected.time || !userId){
        showModal('Erro', 'Selecione serviço, barbeiro, data e hora válidos.'); return;
      }
      const paymentRequired = !(userSubscription && userSubscription.cutsRemaining>0);
      const confirmMsg = paymentRequired
        ? `Confirmar agendamento com pagamento de R$ ${selected.service.price.toFixed(2)} na barbearia?`
        : `Confirmar agendamento usando 1 corte da assinatura?`;
      if(!window.confirm(confirmMsg)) return;

      const appointmentData = {
        barberId: selected.barber.id,
        serviceName: selected.service.id,
        timestamp: selected.time,
        userId,
        paymentMethod: paymentRequired ? 'On-site Payment' : 'Subscription',
        createdAt: serverTimestamp()
      };
      try{
        const ref = collection(db, getAppointmentsCollectionPath());
        await addDoc(ref, appointmentData);

        if(!paymentRequired && userSubscription){
          const subRef = doc(db, getSubscriptionCollectionPath());
          await updateDoc(subRef,{ cutsRemaining: (userSubscription.cutsRemaining||1)-1, lastUsed: serverTimestamp() });
        }

        toast('Agendamento confirmado!');
        showModal('Sucesso', paymentRequired
          ? `Reserva feita: <strong>${selected.service.name}</strong>. Pague <strong>na loja</strong>.`
          : `Reserva feita: <strong>${selected.service.name}</strong>. 1 corte deduzido da assinatura.`);

        selected.time = selected.timeStr = null;
        updateBookingButtonState();
      }catch(e){
        console.error(e);
        showModal('Erro','Não foi possível salvar seu agendamento. Tente novamente.');
      }
    }

    async function purchaseSubscription(planId){
      if(!userId){ showModal('Acesso negado','Faça login para comprar uma assinatura.'); return; }
      const plan = subscriptionPlans.find(p=>p.id===planId);
      if(!plan) return;
      if(!window.confirm(`Confirmar compra do ${plan.name} por R$ ${plan.price.toFixed(2)}? (simulação)`)) return;

      try{
        const subDoc = doc(db, getSubscriptionCollectionPath());
        await setDoc(subDoc, {
          planId: plan.id,
          cutsRemaining: plan.cuts,
          status:'Active',
          lastUpdated: serverTimestamp(),
          purchaseDate: serverTimestamp()
        });
        toast('Assinatura ativada!');
        showModal('Sucesso', `Plano <strong>${plan.name}</strong> comprado. Você tem <strong>${plan.cuts}</strong> cortes.`);
      }catch(e){
        console.error(e);
        showModal('Erro','Falha ao registrar sua assinatura.');
      }
    }

    /* ================== FIREBASE FLOW ================== */
    function initializeFirebase(){
      try{
        if(Object.keys(firebaseConfig).length===0) throw new Error('Firebase config ausente');
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('debug');
        return true;
      }catch(e){
        console.error(e);
        $('#user-display').textContent = 'Erro de Config: Firebase.';
        return false;
      }
    }

    async function authenticateUser(){
      if(!auth) return;
      try{
        if(initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
        else await signInAnonymously(auth);
      }catch{ await signInAnonymously(auth); }
    }

    function setupAuthListener(){
      onAuthStateChanged(auth, (user)=>{
        isAuthReady = true;
        if(user){
          userId = user.uid;
          $('#user-display').innerHTML = `Usuário <span class="font-monospace badge badge-soft rounded-pill px-2">${userId.slice(0,8)}…</span>`;
          setupFirestoreListener();
          setupSubscriptionListener();
        }else{
          authenticateUser();
        }
        renderUserAppointments();
        renderSubscriptionManager();
      });
    }

    function setupFirestoreListener(){
      if(!db) return;
      const ref = collection(db, getAppointmentsCollectionPath());
      onSnapshot(ref, (snap)=>{
        existingAppointments = snap.docs.map(d=>({
          id:d.id, ...d.data(),
          timestamp: d.data().timestamp?.toMillis ? d.data().timestamp.toMillis() : (d.data().timestamp||0)
        }));
        renderTimeSlots();
        renderUserAppointments();
      }, (err)=> console.error('Erro listener appointments', err));
    }

    function setupSubscriptionListener(){
      if(!db || !userId) return;
      const subRef = doc(db, getSubscriptionCollectionPath());
      onSnapshot(subRef, (docSnap)=>{
        userSubscription = docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
        renderSubscriptionManager();
        updateBookingButtonState();
      }, (err)=> console.error('Erro listener subscription', err));
    }

    /* ================== INIT ================== */
    document.addEventListener('DOMContentLoaded', ()=>{
      statusModalInstance = new bootstrap.Modal('#statusModal');
      toastInstance = new bootstrap.Toast('#toast', { delay: 2200 });

      // icons
      lucide.createIcons();

      // logout
      document.getElementById('logout-btn')?.addEventListener('click', async ()=>{
        if(auth){ await signOut(auth); toast('Sessão reiniciada anonimamente.'); }
      });

      // date min + change
      const dateInput = document.getElementById('appointment-date');
      if(dateInput){
        setMinToday(dateInput);
        dateInput.addEventListener('change', (e)=>{
          const v = e.target.value;
          if(v){
            selected.date = v;
            selected.time = null; selected.timeStr = null;
            renderTimeSlots();
          }
        });
      }

      // Firebase boot
      if(initializeFirebase()){ authenticateUser(); setupAuthListener(); }

      // Static
      renderBarbershopInfo();
      renderServices();
      renderBarbers();

      // Book
      document.getElementById('book-button')?.addEventListener('click', handleBooking);
    });
  </script>
</body>
</html>
