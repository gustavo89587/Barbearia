<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbearia Alpha - Agendamento Online</title>
    <!-- Carrega Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- √çcones Lucide --><script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Define a fonte Inter como padr√£o */
        body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #f3f4f6; }
        /* Estilos customizados para o tema de barbearia */
        .barber-bg { background-image: url('https://placehold.co/1200x600/1f2937/d1d5db?text=Barbearia+Alpha'); background-size: cover; background-position: center; }
        .btn-primary {
            @apply px-6 py-3 font-semibold text-lg text-white bg-red-700 rounded-lg shadow-lg hover:bg-red-800 transition duration-300 transform hover:scale-105 active:scale-95 disabled:bg-red-900 disabled:opacity-60;
        }
        .btn-secondary {
            @apply px-4 py-2 font-medium text-gray-300 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-300;
        }
        .card {
            @apply bg-gray-800 p-6 rounded-xl shadow-2xl transition duration-300 hover:shadow-red-700/30 border border-gray-700;
        }
        .header-section {
            @apply text-3xl font-bold text-red-600 mb-4 border-b-2 border-red-700 pb-2;
        }
    </style>
</head>
<body>

    <!-- Conte√∫do principal do aplicativo --><div id="app" class="min-h-screen flex flex-col items-center p-4">

        <!-- Cabe√ßalho (Fixo) --><header class="w-full max-w-4xl bg-gray-900/90 backdrop-blur-sm sticky top-0 z-10 rounded-xl p-4 mb-8 shadow-2xl border-b border-red-700">
            <div class="flex justify-between items-center">
                <!-- Logo da Barbearia --><div class="flex items-center space-x-3">
                    <img id="barbershop-logo" src="https://placehold.co/60x60/374151/d1d5db?text=Logo" alt="Logo da Barbearia Alpha" class="h-12 w-12 rounded-full object-cover">
                    <h1 class="text-4xl font-extrabold text-red-600">Alpha Barbers</h1>
                </div>
                
                <div class="flex items-center space-x-3 text-sm">
                    <span id="user-display" class="text-gray-400">Carregando usu√°rio...</span>
                    <button onclick="handleLogout()" class="text-red-500 hover:text-red-400 transition duration-200">
                        <i data-lucide="log-out" class="w-5 h-5 inline-block"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Se√ß√£o de Informa√ß√µes da Barbearia --><section class="card w-full max-w-4xl mb-8">
            <h2 class="header-section text-2xl">Informa√ß√µes da Barbearia</h2>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Endere√ßo --><div class="flex-1">
                    <p class="font-semibold text-red-400 mb-2 flex items-center"><i data-lucide="map-pin" class="w-5 h-5 mr-2"></i>Endere√ßo</p>
                    <p id="barbershop-address" class="text-gray-300"></p>
                </div>
                <!-- Pagamentos --><div class="flex-1">
                    <p class="font-semibold text-red-400 mb-2 flex items-center"><i data-lucide="wallet" class="w-5 h-5 mr-2"></i>Formas de Pagamento</p>
                    <ul id="payment-methods-list" class="text-gray-300 list-disc list-inside space-y-1">
                        <!-- M√©todos de Pagamento ser√£o injetados aqui --></ul>
                </div>
            </div>
        </section>

        <main class="w-full max-w-4xl space-y-12">
            
            <!-- Se√ß√£o de Gerenciamento de Assinaturas --><section class="card">
                <h2 class="header-section">Gerenciamento de Assinaturas</h2>
                <div id="subscription-manager" class="space-y-4">
                    <!-- Status da Assinatura ser√° injetado aqui --><div id="sub-status-display" class="p-4 bg-gray-900 rounded-lg border border-gray-700">
                        <p class="font-semibold text-lg text-red-400 flex items-center"><i data-lucide="award" class="w-5 h-5 mr-2"></i> Status da Assinatura:</p>
                        <p id="sub-details" class="text-gray-300">Carregando...</p>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-white mt-6">Planos Dispon√≠veis</h3>
                    <div id="subscription-plans-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <!-- Planos de Assinatura ser√£o injetados aqui --></div>
                </div>
            </section>

            <!-- Passo 1: Sele√ß√£o de Servi√ßo --><section class="card">
                <h2 class="header-section">1. Escolha o Servi√ßo (Se Aplic√°vel)</h2>
                <div id="services-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Cards de Servi√ßo ser√£o injetados aqui --></div>
                <div id="selected-service-display" class="mt-6 p-4 bg-gray-900 rounded-lg border border-gray-700 hidden">
                    <p class="font-semibold text-lg text-red-400">Servi√ßo Selecionado:</p>
                    <p id="selected-service-details" class="text-gray-200"></p>
                </div>
            </section>

            <!-- Passo 2: Sele√ß√£o de Barbeiro --><section class="card opacity-50 pointer-events-none" id="barber-selection-section">
                <h2 class="header-section">2. Escolha o Barbeiro</h2>
                <div id="barbers-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Cards de Barbeiro ser√£o injetados aqui --></div>
                <div id="selected-barber-display" class="mt-6 p-4 bg-gray-900 rounded-lg border border-gray-700 hidden">
                    <p class="font-semibold text-lg text-red-400">Barbeiro Selecionado:</p>
                    <p id="selected-barber-details" class="text-gray-200"></p>
                </div>
            </section>
            
            <!-- Passo 3: Sele√ß√£o de Data e Hora --><section class="card opacity-50 pointer-events-none" id="datetime-selection-section">
                <h2 class="header-section">3. Escolha Data e Hora (Seu Calend√°rio)</h2>
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Seletor de Data --><div class="md:w-1/3">
                        <label for="appointment-date" class="block text-sm font-medium text-gray-400 mb-2">Data:</label>
                        <input type="date" id="appointment-date" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-700 text-white focus:ring-red-600 focus:border-red-600">
                    </div>

                    <!-- Hor√°rios Dispon√≠veis --><div class="md:w-2/3">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Hor√°rios Dispon√≠veis:</label>
                        <div id="time-slots-container" class="grid grid-cols-3 sm:grid-cols-4 gap-3 p-3 bg-gray-900 rounded-lg border border-gray-700 min-h-[120px]">
                            <p id="time-slots-message" class="col-span-3 sm:col-span-4 text-center text-gray-500 mt-4">Selecione uma data para ver os hor√°rios.</p>
                            <!-- Slots de Hor√°rio ser√£o injetados aqui --></div>
                    </div>
                </div>

                <button id="book-button" class="btn-primary w-full mt-8 disabled:bg-red-900" disabled onclick="handleBooking()">
                    Agendar Hor√°rio
                </button>
            </section>

            <!-- Se√ß√£o de Agendamentos Futuros (Simula√ß√£o de Dashboard) --><section class="card">
                <h2 class="header-section">Seus Agendamentos Futuros</h2>
                <div id="user-appointments-list" class="space-y-4">
                    <p id="no-appointments-message" class="text-center text-gray-500 mt-4">Nenhum agendamento encontrado.</p>
                    <!-- Agendamentos do Usu√°rio ser√£o injetados aqui --></div>
            </section>

            <!-- Status e Mensagens (Modal de Notifica√ß√£o) --><div id="status-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
                <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full border border-red-700">
                    <h3 id="modal-title" class="text-2xl font-bold mb-4 text-red-600">Status</h3>
                    <p id="modal-message" class="text-gray-300 mb-6"></p>
                    <button onclick="hideModal()" class="btn-secondary w-full">Fechar</button>
                </div>
            </div>

        </main>

    </div>

    <!-- Bibliotecas Firebase --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, serverTimestamp, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura√ß√µes e Vari√°veis Globais (MANDAT√ìRIAS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Vari√°veis globais do app
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let selected = {
            service: null,
            barber: null,
            date: null,
            time: null, // timestamp exato do agendamento
            timeStr: null // string de hora (ex: "10:00")
        };
        let existingAppointments = [];
        let userSubscription = null; // { planId: 'trimestral', cutsRemaining: 3, status: 'Active', ... }

        // Dados est√°ticos da barbearia
        const services = [
            { id: 'corte', name: 'Corte de Cabelo Cl√°ssico', price: 60.00, duration: 60, icon: 'scissors' },
            { id: 'barba', name: 'Design de Barba', price: 40.00, duration: 30, icon: 'beard' },
            { id: 'completo', name: 'Combo (Corte + Barba)', price: 90.00, duration: 90, icon: 'chevrons-up-down' },
            { id: 'pigmentacao', name: 'Pigmenta√ß√£o', price: 50.00, duration: 45, icon: 'palette' }
        ];

        const barbers = [
            { id: 'joao', name: 'Jo√£o "O Mestre"', specialty: 'Cl√°ssico e Taper Fade', image: 'https://placehold.co/100x100/374151/9ca3af?text=JO' },
            { id: 'maria', name: 'Maria "A Navalha"', specialty: 'Barba Terapia e Design Feminino', image: 'https://placehold.co/100x100/374151/9ca3af?text=MA' },
            { id: 'pedro', name: 'Pedro "O Artista"', specialty: 'Freestyle e Colorimetria', image: 'https://placehold.co/100x100/374151/9ca3af?text=PE' }
        ];
        
        const barbershopInfo = {
            name: "Alpha Barbers",
            address: 'Rua da Tecnologia, 123 - Centro, S√£o Paulo/SP',
            payments: ['Cart√£o de Cr√©dito/D√©bito (Visa, Master)', 'Pix (Chave: 1234567890)', 'Dinheiro'],
            logoUrl: '1000254662.png' // **SUBSTITUA PELA URL DO SEU LOGO REAL**
        };

        const subscriptionPlans = [
            { id: 'trimestral', name: 'Plano Trimestral', cuts: 4, price: 200.00, description: '4 cortes em 90 dias' },
            { id: 'mensal', name: 'Plano Mensal', cuts: 2, price: 100.00, description: '2 cortes em 30 dias' }
        ];

        // --- Fun√ß√µes de Utilidade ---

        // Fun√ß√£o para mostrar o modal de status/mensagem
        window.showModal = function(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('status-modal').classList.remove('hidden', 'opacity-0');
            document.getElementById('status-modal').classList.add('flex', 'opacity-100');
        }

        // Fun√ß√£o para esconder o modal de status/mensagem
        window.hideModal = function() {
            document.getElementById('status-modal').classList.add('hidden');
            document.getElementById('status-modal').classList.remove('flex');
        }
        
        // Converte a hora (ex: "10:00") para um objeto Date na data selecionada.
        function timeToDate(dateStr, timeStr) {
            if (!dateStr || !timeStr) return null;
            const [year, month, day] = dateStr.split('-').map(Number);
            const [hour, minute] = timeStr.split(':').map(Number);
            const date = new Date(year, month - 1, day, hour, minute);
            return date;
        }

        // --- Renderiza√ß√£o de UI ---

        // Renderiza informa√ß√µes da barbearia
        function renderBarbershopInfo() {
            const logoElement = document.getElementById('barbershop-logo');
            if (logoElement && barbershopInfo.logoUrl) {
                logoElement.src = barbershopInfo.logoUrl;
            }

            const addressElement = document.getElementById('barbershop-address');
            if (addressElement) {
                addressElement.textContent = barbershopInfo.address;
            }
            
            const paymentsList = document.getElementById('payment-methods-list');
            if (paymentsList) {
                paymentsList.innerHTML = barbershopInfo.payments.map(p => `<li>${p}</li>`).join('');
            }
            lucide.createIcons();
        }

        // 1. Renderiza os cart√µes de servi√ßo
        function renderServices() {
            const list = document.getElementById('services-list');
            if (!list) return;

            list.innerHTML = services.map(s => `
                <div class="card cursor-pointer flex items-center space-x-4 border-2 border-gray-700 hover:border-red-600 transition duration-200"
                    onclick="selectService('${s.id}')" data-service-id="${s.id}">
                    <i data-lucide="${s.icon}" class="w-8 h-8 text-red-600 flex-shrink-0"></i>
                    <div>
                        <h3 class="font-bold text-xl text-white">${s.name}</h3>
                        <p class="text-gray-400">R$ ${s.price.toFixed(2)} (${s.duration} min)</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
            updateSelectedServiceUI();
        }
        
        // Atualiza o estado visual do servi√ßo selecionado
        function updateSelectedServiceUI() {
            document.querySelectorAll('[data-service-id]').forEach(el => {
                if (el.dataset.serviceId === selected.service?.id) {
                    el.classList.add('border-red-600', 'ring-2', 'ring-red-600');
                    el.classList.remove('border-gray-700', 'hover:border-red-600');
                } else {
                    el.classList.remove('border-red-600', 'ring-2', 'ring-red-600');
                    el.classList.add('border-gray-700', 'hover:border-red-600');
                }
            });

            const display = document.getElementById('selected-service-display');
            const barberSection = document.getElementById('barber-selection-section');
            if (!display || !barberSection) return;

            if (selected.service) {
                display.classList.remove('hidden');
                document.getElementById('selected-service-details').innerHTML = `${selected.service.name} - **R$ ${selected.service.price.toFixed(2)}**`;
                
                // Ativa o pr√≥ximo passo
                barberSection.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                display.classList.add('hidden');
                barberSection.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        // 2. Renderiza os cart√µes de barbeiro
        function renderBarbers() {
            const list = document.getElementById('barbers-list');
            if (!list) return;

            list.innerHTML = barbers.map(b => `
                <div class="card cursor-pointer flex flex-col items-center space-y-3 border-2 border-gray-700 hover:border-red-600 transition duration-200 text-center"
                    onclick="selectBarber('${b.id}')" data-barber-id="${b.id}">
                    <img src="${b.image}" alt="[Imagem de ${b.name}]" class="w-20 h-20 rounded-full object-cover border-4 border-gray-700">
                    <h3 class="font-bold text-lg text-white">${b.name}</h3>
                    <p class="text-sm text-red-400">${b.specialty}</p>
                </div>
            `).join('');
            updateSelectedBarberUI();
        }

        // Atualiza o estado visual do barbeiro selecionado
        function updateSelectedBarberUI() {
            document.querySelectorAll('[data-barber-id]').forEach(el => {
                if (el.dataset.barberId === selected.barber?.id) {
                    el.classList.add('border-red-600', 'ring-2', 'ring-red-600');
                    el.classList.remove('border-gray-700', 'hover:border-red-600');
                } else {
                    el.classList.remove('border-red-600', 'ring-2', 'ring-red-600');
                    el.classList.add('border-gray-700', 'hover:border-red-600');
                }
            });

            const display = document.getElementById('selected-barber-display');
            const datetimeSection = document.getElementById('datetime-selection-section');
            if (!display || !datetimeSection) return;

            if (selected.barber) {
                display.classList.remove('hidden');
                document.getElementById('selected-barber-details').innerHTML = `${selected.barber.name} (${selected.barber.specialty})`;
                 // Ativa o pr√≥ximo passo
                datetimeSection.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                display.classList.add('hidden');
                datetimeSection.classList.add('opacity-50', 'pointer-events-none');
            }
        }
        
        // 3. Renderiza os hor√°rios dispon√≠veis
        function renderTimeSlots() {
            const container = document.getElementById('time-slots-container');
            const message = document.getElementById('time-slots-message');
            
            // Verifica√ß√£o de seguran√ßa: interrompe se os elementos n√£o existirem
            if (!container || !message) {
                console.warn("DOM elements for time slots not found. Skipping render.");
                return;
            }

            container.innerHTML = '';
            message.classList.add('hidden');

            if (!selected.date) {
                message.textContent = "Selecione uma data para ver os hor√°rios.";
                message.classList.remove('hidden');
                return;
            }

            // Hor√°rios de funcionamento (8:00 √†s 18:00, slots de 1h)
            const openTime = 8 * 60; // 480 minutos (8:00)
            const closeTime = 18 * 60; // 1080 minutos (18:00)
            const slotDuration = 60; // Dura√ß√£o do slot em minutos (para simplificar)

            // Gera todos os slots poss√≠veis
            let availableSlots = [];
            for (let time = openTime; time < closeTime; time += slotDuration) {
                const hour = Math.floor(time / 60);
                const minute = time % 60;
                const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                availableSlots.push(timeStr);
            }
            
            // Filtra os slots j√° agendados
            const bookedTimes = existingAppointments
                .filter(app => {
                    // Nota: A data do agendamento deve ser comparada como string YYYY-MM-DD
                    const appDate = new Date(app.timestamp).toISOString().split('T')[0];
                    return appDate === selected.date && app.barberId === selected.barber?.id;
                })
                .map(app => new Date(app.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }));

            let hasAvailableSlot = false;

            availableSlots.forEach(timeStr => {
                const isBooked = bookedTimes.includes(timeStr);
                const isSelected = timeStr === selected.timeStr;

                if (!isBooked) {
                    hasAvailableSlot = true;
                }

                container.innerHTML += `
                    <button onclick="selectTime('${timeStr}')"
                        class="p-2 rounded-lg font-medium transition duration-200
                        ${isSelected ? 'bg-red-600 text-white shadow-md' : (isBooked ? 'bg-gray-700 text-gray-500 cursor-not-allowed line-through' : 'bg-gray-700 text-white hover:bg-red-700')}
                        "
                        ${isBooked ? 'disabled' : ''}>
                        ${timeStr}
                    </button>
                `;
            });

            if (!hasAvailableSlot) {
                message.textContent = "Nenhum hor√°rio dispon√≠vel para este dia/barbeiro. Tente outra data.";
                message.classList.remove('hidden');
            }

            updateBookingButtonState();
        }

        // Atualiza o estado do bot√£o de agendamento
        function updateBookingButtonState() {
            const btn = document.getElementById('book-button');
            if (!btn) return;

            let actionText = 'Agendar Hor√°rio';
            
            if (userSubscription && userSubscription.cutsRemaining > 0) {
                actionText = `Usar 1 Corte da Assinatura (${userSubscription.cutsRemaining} restantes)`;
            } else {
                actionText = 'Agendar (Pagamento na Loja)';
            }
            
            if (selected.service && selected.barber && selected.date && selected.time) {
                btn.disabled = false;
                btn.textContent = actionText;
            } else {
                btn.disabled = true;
                btn.textContent = 'Selecione Servi√ßo, Barbeiro, Data e Hora';
            }
        }
        
        // Renderiza a lista de agendamentos do usu√°rio
        function renderUserAppointments() {
            const list = document.getElementById('user-appointments-list');
            const message = document.getElementById('no-appointments-message');
            
            // Verifica√ß√£o de seguran√ßa: interrompe se os elementos n√£o existirem
            if (!list || !message) {
                console.warn("DOM elements for appointments not found. Skipping render.");
                return;
            }

            list.innerHTML = '';
            
            if (!isAuthReady || !userId) {
                list.innerHTML = `<p class="text-center text-gray-500 mt-4">Fa√ßa login para ver seus agendamentos.</p>`;
                return;
            }

            // Filtra agendamentos futuros do usu√°rio logado
            const now = Date.now();
            const userFutureAppointments = existingAppointments
                .filter(app => app.userId === userId && app.timestamp > now)
                .sort((a, b) => a.timestamp - b.timestamp);

            if (userFutureAppointments.length === 0) {
                message.classList.remove('hidden');
                return;
            }

            message.classList.add('hidden');
            
            userFutureAppointments.forEach(app => {
                const date = new Date(app.timestamp);
                const dateStr = date.toLocaleDateString('pt-BR');
                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const barber = barbers.find(b => b.id === app.barberId)?.name || app.barberId;
                const service = services.find(s => s.id === app.serviceName)?.name || app.serviceName;

                list.innerHTML += `
                    <div class="card flex justify-between items-center p-4">
                        <div>
                            <p class="text-xl font-bold text-red-500">${service}</p>
                            <p class="text-gray-300">Com ${barber}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-semibold text-white">${dateStr}</p>
                            <p class="text-red-400 text-sm">${timeStr}</p>
                        </div>
                    </div>
                `;
            });
            checkForUpcomingAppointment(userFutureAppointments);
        }

        // --- Alerta de Pr√≥ximo Agendamento ---
        function checkForUpcomingAppointment(appointments) {
            const now = Date.now();
            // Pr√≥ximas 24 horas (86,400,000 milissegundos)
            const tomorrow = now + 86400000; 

            const upcoming = appointments.find(app => app.timestamp > now && app.timestamp <= tomorrow);

            if (upcoming) {
                const date = new Date(upcoming.timestamp);
                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const service = services.find(s => s.id === upcoming.serviceName)?.name || "Corte";
                const barber = barbers.find(b => b.id === upcoming.barberId)?.name || "Barbeiro";

                showModal(
                    'Lembrete de Agendamento!',
                    `Voc√™ tem um agendamento de **${service}** com **${barber}** hoje/amanh√£ √†s **${timeStr}**. N√£o se atrase! üíà`
                );
            }
        }

        // --- Gerenciamento de Assinaturas (UI) ---
        function renderSubscriptionManager() {
            const detailsElement = document.getElementById('sub-details');
            const plansList = document.getElementById('subscription-plans-list');
            if (!detailsElement || !plansList) return;
            
            plansList.innerHTML = subscriptionPlans.map(plan => `
                <div class="card p-4 border-2 border-gray-700">
                    <h3 class="font-bold text-xl text-red-500">${plan.name}</h3>
                    <p class="text-gray-400">${plan.description}</p>
                    <p class="text-lg font-semibold text-white mt-2">R$ ${plan.price.toFixed(2)}</p>
                    <button onclick="purchaseSubscription('${plan.id}')" class="btn-primary mt-3 w-full text-sm">Comprar Plano</button>
                </div>
            `).join('');


            if (!isAuthReady) {
                detailsElement.textContent = 'Fa√ßa login para gerenciar sua assinatura.';
                return;
            }

            if (userSubscription && userSubscription.planId) {
                const planDetails = subscriptionPlans.find(p => p.id === userSubscription.planId);
                const cuts = userSubscription.cutsRemaining;
                const status = cuts > 0 ? 'ATIVA' : 'Cortes Esgotados';
                const statusColor = cuts > 0 ? 'text-green-400' : 'text-yellow-400';
                
                detailsElement.innerHTML = `
                    **Plano:** ${planDetails?.name || 'Desconhecido'} <br>
                    **Status:** <span class="${statusColor}">${status}</span> <br>
                    **Cortes Restantes:** <span class="text-white font-bold text-xl">${cuts}</span>
                `;
            } else {
                detailsElement.innerHTML = 'Voc√™ n√£o possui uma assinatura ativa. Escolha um plano abaixo para come√ßar a economizar!';
            }
        }
        
        // Simula√ß√£o de compra de assinatura
        window.purchaseSubscription = async function(planId) {
            if (!userId) {
                showModal('Acesso Negado', 'Por favor, fa√ßa login para comprar uma assinatura.');
                return;
            }
            
            const plan = subscriptionPlans.find(p => p.id === planId);

            // Simula√ß√£o de confirma√ß√£o de pagamento
            if (!window.confirm(`Confirmar a compra do ${plan.name} por R$ ${plan.price.toFixed(2)}? (Simula√ß√£o)`)) {
                return;
            }

            try {
                const docRef = doc(db, getSubscriptionCollectionPath());
                await setDoc(docRef, {
                    planId: plan.id,
                    cutsRemaining: plan.cuts,
                    status: 'Active',
                    lastUpdated: serverTimestamp(),
                    purchaseDate: serverTimestamp()
                });

                showModal('Sucesso!', `Assinatura **${plan.name}** comprada com sucesso! Voc√™ tem **${plan.cuts}** cortes dispon√≠veis.`);

            } catch (error) {
                console.error("Erro ao comprar assinatura:", error);
                showModal('Erro na Compra', 'N√£o foi poss√≠vel registrar sua assinatura.');
            }
        }


        // --- L√≥gica de Sele√ß√£o ---

        // Fun√ß√£o para selecionar um servi√ßo
        window.selectService = function(serviceId) {
            // Nota: Manteve-se a sele√ß√£o de servi√ßo para flexibilidade, mas o agendamento de corte usar√° a assinatura
            selected.service = services.find(s => s.id === serviceId);
            selected.barber = null;
            selected.date = null;
            selected.time = null;
            selected.timeStr = null;
            updateSelectedServiceUI();
            updateSelectedBarberUI();
            renderTimeSlots(); // Limpa os slots
            updateBookingButtonState();
        }

        // Fun√ß√£o para selecionar um barbeiro
        window.selectBarber = function(barberId) {
            if (!selected.service) {
                showModal('Aten√ß√£o', 'Primeiro, selecione um servi√ßo!');
                return;
            }
            selected.barber = barbers.find(b => b.id === barberId);
            selected.date = null; // Limpa a data para for√ßar a revalida√ß√£o
            selected.time = null;
            selected.timeStr = null;
            const appointmentDateInput = document.getElementById('appointment-date');
            if (appointmentDateInput) {
                appointmentDateInput.value = ''; // Limpa o input
            }
            updateSelectedBarberUI();
            renderTimeSlots(); // Limpa/Reseta os slots
            updateBookingButtonState();
        }

        // Fun√ß√£o para selecionar a hora
        window.selectTime = function(timeStr) {
            if (!selected.date || !selected.barber) return;
            
            selected.timeStr = timeStr;
            const appointmentDateObj = timeToDate(selected.date, timeStr);
            selected.time = appointmentDateObj ? appointmentDateObj.getTime() : null;
            
            renderTimeSlots(); // Redesenha para destacar o hor√°rio selecionado
            updateBookingButtonState();
        }

        // Listener para mudan√ßa de data
        const appointmentDateInput = document.getElementById('appointment-date');
        if (appointmentDateInput) {
            appointmentDateInput.addEventListener('change', (e) => {
                const newDate = e.target.value;
                if (newDate) {
                    selected.date = newDate;
                    selected.time = null;
                    selected.timeStr = null;
                    renderTimeSlots();
                }
            });
        }


        // --- L√≥gica de Agendamento (Firestore) ---

        async function handleBooking() {
            if (!selected.service || !selected.barber || !selected.time || !userId) {
                showModal('Erro', 'Por favor, selecione um servi√ßo, barbeiro, data e hora v√°lidos.');
                return;
            }

            const appointmentDateObj = new Date(selected.time);
            let paymentRequired = false;
            let successMessage = '';
            
            // 1. L√≥gica de Assinatura
            if (userSubscription && userSubscription.cutsRemaining > 0) {
                // Usar corte da assinatura
                successMessage = `Seu agendamento de **${selected.service.name}** foi confirmado! 
                                  Um corte foi deduzido da sua assinatura.`;
            } else {
                // N√£o tem assinatura ou cortes restantes = Requer pagamento (simula√ß√£o)
                paymentRequired = true;
                successMessage = `Seu agendamento de **${selected.service.name}** foi reservado. 
                                  O pagamento de **R$ ${selected.service.price.toFixed(2)}** ser√° feito na barbearia.`;
            }

            // Confirma√ß√£o (Simula a confirma√ß√£o real com o m√©todo de pagamento/assinatura)
            if (!window.confirm(paymentRequired ? `Confirmar agendamento com pagamento na barbearia?` : `Confirmar agendamento usando 1 corte da sua assinatura?`)) {
                return;
            }
            
            // 2. Cria√ß√£o do Agendamento
            const appointmentData = {
                barberId: selected.barber.id,
                serviceName: selected.service.id,
                timestamp: selected.time,
                userId: userId,
                paymentMethod: paymentRequired ? 'On-site Payment' : 'Subscription',
                createdAt: serverTimestamp() 
            };

            try {
                // Adiciona o agendamento
                const appointmentsRef = collection(db, getAppointmentsCollectionPath());
                await addDoc(appointmentsRef, appointmentData);

                // 3. Atualiza Assinatura (se usada)
                if (!paymentRequired && userSubscription) {
                    const subDocRef = doc(db, getSubscriptionCollectionPath());
                    await updateDoc(subDocRef, {
                        cutsRemaining: userSubscription.cutsRemaining - 1,
                        lastUsed: serverTimestamp()
                    });
                }
                
                showModal('Sucesso!', successMessage);
                
                // Limpa a sele√ß√£o ap√≥s o sucesso
                selected.time = null;
                selected.timeStr = null;
                updateBookingButtonState();

            } catch (error) {
                console.error("Erro ao agendar:", error);
                showModal('Erro no Agendamento', 'N√£o foi poss√≠vel salvar seu agendamento. Tente novamente.');
            }
        }


        // --- FIREBASE E AUTENTICA√á√ÉO ---

        function getAppointmentsCollectionPath() {
            // Caminho para dados p√∫blicos de agendamentos: /artifacts/{appId}/public/data/{your_collection_name}
            return `artifacts/${appId}/public/data/barbershop_appointments`;
        }
        
        function getSubscriptionCollectionPath(docId = 'current') {
            // Caminho para dados privados do usu√°rio: /artifacts/{appId}/users/{userId}/subscriptions/{documentId}
            return `artifacts/${appId}/users/${userId}/subscriptions/${docId}`;
        }


        // 1. Inicializa o Firebase
        function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug'); // Ativa logs de debug do Firestore
                    return true;
                } else {
                    console.error("Configura√ß√£o do Firebase n√£o encontrada.");
                    const userDisplay = document.getElementById('user-display');
                    if (userDisplay) userDisplay.textContent = 'Erro de Config: Sem Firebase';
                    return false;
                }
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                const userDisplay = document.getElementById('user-display');
                if (userDisplay) userDisplay.textContent = 'Erro de Config: Firebase';
                return false;
            }
        }

        // 2. Realiza a Autentica√ß√£o (Mantida An√¥nima)
        async function authenticateUser() {
            if (!auth) return;

            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
        }
        
        // 3. Listener de Estado de Autentica√ß√£o
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    userId = user.uid;
                    const userDisplay = document.getElementById('user-display');
                    if (userDisplay) userDisplay.innerHTML = `Usu√°rio ID: <span class="font-mono text-red-400">${userId.substring(0, 8)}...</span>`;
                    // Inicia os listeners de dados ap√≥s a autentica√ß√£o
                    setupFirestoreListener(); // Agendamentos p√∫blicos
                    setupSubscriptionListener(); // Assinatura privada
                } else {
                    authenticateUser();
                }
                renderUserAppointments();
                renderSubscriptionManager();
            });
        }
        
        // 4a. Listener de Agendamentos (Real-time - Dados P√∫blicos)
        function setupFirestoreListener() {
            if (!db || !userId) return;

            const appointmentsRef = collection(db, getAppointmentsCollectionPath());
            const q = appointmentsRef; 

            onSnapshot(q, (snapshot) => {
                existingAppointments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toMillis ? doc.data().timestamp.toMillis() : (doc.data().timestamp || 0)
                }));
                
                console.log("Agendamentos carregados/atualizados:", existingAppointments.length);
                renderTimeSlots();
                renderUserAppointments();

            }, (error) => {
                console.error("Erro ao ouvir agendamentos:", error);
                // N√£o mostra modal para n√£o poluir, apenas loga
            });
        }
        
        // 4b. Listener de Assinatura (Real-time - Dados Privados)
        function setupSubscriptionListener() {
            if (!db || !userId) return;
            
            const subDocRef = doc(db, getSubscriptionCollectionPath());

            onSnapshot(subDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    userSubscription = {
                        id: docSnap.id,
                        ...docSnap.data()
                    };
                    console.log("Status da Assinatura carregado:", userSubscription);
                } else {
                    userSubscription = null;
                    console.log("Nenhuma assinatura encontrada para o usu√°rio.");
                }
                renderSubscriptionManager();
                updateBookingButtonState();
            }, (error) => {
                console.error("Erro ao ouvir assinatura:", error);
            });
        }
        
        // Simula√ß√£o de Logout (apenas para fins de demonstra√ß√£o, loga anonimamente em seguida)
        window.handleLogout = async function() {
            if (auth) {
                await signOut(auth);
                showModal('Logout', 'Sess√£o encerrada. Voc√™ foi reconectado anonimamente para continuar o agendamento.');
            }
        }

        // --- INICIALIZA√á√ÉO GERAL ---
        document.addEventListener('DOMContentLoaded', () => {
            if (initializeFirebase()) {
                authenticateUser();
                setupAuthListener();
            }

            // Renderiza dados est√°ticos
            renderBarbershopInfo();
            renderServices();
            renderBarbers();
        });

        // Define a data m√≠nima como hoje
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // M√™s come√ßa em 0
        const dd = String(today.getDate()).padStart(2, '0');
        const appointmentDateInputMin = document.getElementById('appointment-date');
        if (appointmentDateInputMin) {
            appointmentDateInputMin.min = `${yyyy}-${mm}-${dd}`;
        }

    </script>

</body>
</html>
